name: aws_test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  workflow_dispatch:

jobs:
  awstest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # update the operating system
      - name: update OS
        run: sudo apt-get update

      # install AWSCLI
      - name: install awscli
        run: ./bin/install_awscli.sh

      # figure out what system we are on
      - name: kernelquery
        run: uname -a

      # figure out what distro we are on
      - name: distroquery
        run: cat /etc/lsb-release

      # read AWS certificate
      - name: read secret
        run: |
          mkdir -p ~/.ssh
          echo "$AWSPEM" > ~/.ssh/aws.pem
          chmod 0600 ~/.ssh/aws.pem
        env:
          AWSPEM: ${{secrets.GEORGES_AWS_KEYPAIR}}

      # print checksum
      - name: checksum
        run: |
	  sha1sum ~/.ssh/aws.pem
	  wc ~/.ssh/aws.pem

      # use AWS certificate to contact our VM
      - name: server uptime
        run: ssh -i ~/.ssh/aws.pem ubuntu@54.145.76.53 uptime
